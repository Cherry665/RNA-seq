# 什么是Log2FC？
FC就是Fold Change就是倍数差异，就是将对照组与实验组的基因表达量的差别，一般将Fold Change等于2作为是否差异的临界点，那么对应的Log2FC就是1。

```R
# padj 小于 0.05 并且 Log2FC 大于 1 或者小于 -1
diff_gene <- subset(result_order, padj < 0.05 & abs(log2FoldChange) > 1)

# 查看数据框的大小
dim(diff_gene)
```

输出结果为：  
59代表59行：代表找到了 59 个显著差异表达基因  
6代表6列：代表每个基因有 6 个统计指标，如baseMean等  

```
[1] 59  6
```

# 使用ClusterProfiler对基因的ID进行转化
clusterProfiler包和大鼠数据库前面已经安装，加载一下即可(如果保存了也可以不加载)  

```R
# 加载包
library(clusterProfiler)
library(org.Rn.eg.db)

# 得到基因ID(这个ID是Ensembl数据库的编号)
ensembl_gene_id <- row.names(diff_gene)

# 转换函数（ENSEMBL_ID是输入的基因ID，fromType是输入的ID类型，toType是输出的ID类型（SYMBOL: 基因符号（如：Alb, Actb）ENTREZID: Entrez基因ID（数字编号）），OrgDb注释的db文件，drop表示是否剔除NA数据）
ensembl_id_transform <- function(ENSEMBL_ID){
    a = bitr(ENSEMBL_ID, fromType="ENSEMBL", toType=c("SYMBOL","ENTREZID"), OrgDb="org.Rn.eg.db")
    return(a)
}

# 开始转化
ensembl_id_transform(ensembl_gene_id)
```

输出结果为：  
可以看出有部分基因没有映射到  
```
              ENSEMBL   SYMBOL  ENTREZID
1  ENSRNOG00000047945  Cyp2c12     25011
2  ENSRNOG00000012404    Thrsp     25357
3  ENSRNOG00000017619  Aldh1a1     24188
4  ENSRNOG00000016573    Dgat2    252900
.........
Warning message:
In bitr(ENSEMBL_ID, fromType = "ENSEMBL", toType = c("SYMBOL", "ENTREZID"),  :
  13.56% of input gene IDs are fail to map...
```

# 使用biomaRt进行注释

```R
# 加载
library("biomaRt")

# 选择数据库,使用 biomaRt 包连接到大鼠 Ensembl 数据库
mart <- useDataset("rnorvegicus_gene_ensembl", useMart("ENSEMBL_MART_ENSEMBL"))

# 得到基因ID(这个ID是Ensembl数据库的编号)
# attributes：要获取的信息，Ensembl 基因 ID、基因符号、Entrez 基因 ID和基因功能描述
# filters：查询条件，使用 Ensembl 基因 ID 作为查询条件
# values：具体的查询值，根据前面得到的ensembl_gene_id
# mart：数据库连接，使用之前建立的到大鼠 Ensembl 数据库的连接
ensembl_gene_id <- row.names(diff_gene)
rat_symbols <- getBM(attributes=c("ensembl_gene_id","external_gene_name","entrezgene_id", "description"), filters = 'ensembl_gene_id', values = ensembl_gene_id, mart = mart)
```

利用head()查看`rat_symbols`结果：  
```
     ensembl_gene_id external_gene_name entrezgene_id                                                          description
1 ENSRNOG00000001466            Cyp2c55     100361492   cytochrome P450, family 2, subfamily c, polypeptide 55 [Source:RGD  Symbol;Acc:2320073]
2 ENSRNOG00000004273             Ifitm1        293618   interferon induced transmembrane protein 1 [Source:RGD Symbol;Acc:1307601]
3 ENSRNOG00000010918              Cebpa         24252   CCAAT/enhancer binding protein alpha [Source:RGD Symbol;Acc:2326]
4 ENSRNOG00000011068             Papss2        294103   3'-phosphoadenosine 5'-phosphosulfate synthase 2 [Source:RGD Symbol;Acc:1307012]
5 ENSRNOG00000011451               Lrp3         89787   LDL receptor related protein 3 [Source:RGD Symbol;Acc:619729]
6 ENSRNOG00000011931            Smarca2        361745   SWI/SNF related, matrix associated, actin dependent regulator of chromatin, subfamily a, member 2 [Source:RGD Symbol;Acc:1302988]
```

# 将基因矩阵与symbols合并
```R
# 生成用于合并的列,在diff_gene后面加上一列列名为ensembl_gene_id的列
diff_gene$ensembl_gene_id <- ensembl_gene_id
# 将diff_gene转换并保存为一个标准的数据框diff_gene_dataframe
diff_gene_dataframe <- as.data.frame(diff_gene)
# 基于ensembl_gene_id列将diff_gene_dataframe和rat_symbols两个数据框合并为diff_gene_symbols
diff_gene_symbols <- merge(diff_gene_dataframe, rat_symbols, by = c("ensembl_gene_id"))
```

利用head()查看`diff_gene_symbols`结果：  
```
     ensembl_gene_id  baseMean log2FoldChange     lfcSE      stat       pvalue
1 ENSRNOG00000001466  36.56804       6.680844 1.4980682  4.459640 8.209759e-06
2 ENSRNOG00000004273  32.22694       3.417890 0.8870207  3.853224 1.165726e-04
3 ENSRNOG00000010918 179.98279      -1.086207 0.2987013 -3.636431 2.764412e-04
4 ENSRNOG00000011068 104.99135      -1.155093 0.3294428 -3.506201 4.545519e-04
5 ENSRNOG00000011451  60.04113      -1.686507 0.3646260 -4.625307 3.740443e-06
6 ENSRNOG00000011931  26.57502      -1.366681 0.3925503 -3.481544 4.985312e-04
          padj external_gene_name entrezgene_id
1 0.0005674723            Cyp2c55     100361492
2 0.0041879775             Ifitm1        293618
3 0.0076613712              Cebpa         24252
4 0.0119166317             Papss2        294103
5 0.0002803120               Lrp3         89787
6 0.0123993650            Smarca2        361745
                                                                                                                        description
1                                            cytochrome P450, family 2, subfamily c, polypeptide 55 [Source:RGD Symbol;Acc:2320073]
2                                                        interferon induced transmembrane protein 1 [Source:RGD Symbol;Acc:1307601]
3                                                                 CCAAT/enhancer binding protein alpha [Source:RGD Symbol;Acc:2326]
4                                                  3'-phosphoadenosine 5'-phosphosulfate synthase 2 [Source:RGD Symbol;Acc:1307012]
5                                                                     LDL receptor related protein 3 [Source:RGD Symbol;Acc:619729]
6 SWI/SNF related, matrix associated, actin dependent regulator of chromatin, subfamily a, member 2 [Source:RGD Symbol;Acc:1302988]
```

# 将数据存储起来

```R
# 先创建目录
dir.create("../stat/")
# 再保存文件
write.table(result, "../stat/all_gene.tsv", sep="\t", quote = FALSE)
write.table(diff_gene_symbols, "../stat/diff_gene.tsv", row.names = F,sep="\t", quote = FALSE)
```

# 统计样本的差异基因

```bash
cd ~/project/rat/output
# 新建all_samples.tsv文件并写入标题
echo -e "sample\tnum" > all_samples.tsv

for i in $(ls);
do
    if [ -d ${i} ];
    then
        prefix=$i
        diff_num=$(cat $i/diff_gene.tsv | tail -n+2 | wc -l)
        echo -e "${prefix}\t${diff_num}" >> all_samples.tsv
    fi
done
```

输出结果为（很奇怪，样本名是目录名，修改all_samples.tsv所在的目录也不行，因为diff_gene.tsv只有一个，后面分析要用的时候会生成多个diff_gene.tsv才有用？）：
```
sample	num
DESeq2	0
HTseq	0
adapter	0
align	0
fastqc	0
fastqc_trim	0
rRNA	0
stat	52
trim	0
```

# 使用R绘图

```R
library(ggplot2)
data <- read.table("all_samples.tsv", header = T)

pdf("samples_diff_gene_num.pdf")
  ggplot(data=data, aes(x=sample, y=num, fill=sample)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "samples",y = "num",title = "different gene number")
dev.off()
```